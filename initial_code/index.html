<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JONSWAP Wave Spectrum & RAO</title>
  <!-- Load Chart.js and plugins -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.1.2/chart.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script src="datascript.js"></script>
  <!-- Same styles as original -->
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    #container { width: 900px; }
    h1 {
      text-align: center;
      margin-top: 40px;
      margin-bottom: 10px;
      color: rgb(45, 185, 164);
      font-size: 24px;
    }
    h1:first-child { margin-top: 0; }
    h2 {
      text-align: center;
      margin: 0 0 24px 0;
      font-size: 18px;
    }
    h3 {
      text-align: center;
      margin-top: 16px;
      margin-bottom: 12px;
      font-size: 16px;
    }
    .chart-section { margin-bottom: 48px; }
    canvas {
      display: block;
      margin: 0 auto 24px auto;
    }
    .chart-row {
      display: flex;
      gap: 20px;
      margin: 0;
    }
    .chart-box { flex: 1; }
    .chart-box h3 {
      margin-top: 0;
      margin-bottom: 12px;
    }
    .controls {
      text-align: center;
      margin-bottom: 20px;
    }
    .controls button {
      padding: 8px 20px;
      margin: 0 10px;
      font-size: 16px;
      cursor: pointer;
      background-color: rgb(45, 185, 164);
      color: white;
      border: none;
      border-radius: 4px;
    }
    .controls button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Sensor1 Live Data Section -->
    <div class="chart-section">
      <h1>Sensor1 Data</h1>
      <div class="controls">
        <button id="startBtn1">Start</button>
        <button id="stopBtn1">Stop</button>
      </div>
      <div class="chart-row">
        <div class="chart-box">
          <h3>Wave Height</h3>
          <canvas id="waveHeightChart" width="400" height="300"></canvas>
        </div>
        <div class="chart-box">
          <h3>Wave Period</h3>
          <canvas id="wavePeriodChart" width="400" height="300"></canvas>
        </div>
      </div>
      <div class="chart-box" style="max-width: 600px; margin: 0 auto;">
        <h3>Wave Direction</h3>
        <canvas id="waveDirectionChart" width="600" height="300"></canvas>
      </div>
    </div>

    <!-- Sensor2 Live Data Section -->
    <div class="chart-section">
      <h1>Sensor2 Data</h1>
      <div class="controls">
        <button id="startBtn2">Start</button>
        <button id="stopBtn2">Stop</button>
      </div>
      <div class="chart-row">
        <div class="chart-box">
          <h3>Vessel Heading</h3>
          <canvas id="vesselHeadingChart" width="400" height="300"></canvas>
        </div>
        <div class="chart-box">
          <h3>Vessel Speed</h3>
          <canvas id="vesselSpeedChart" width="400" height="300"></canvas>
        </div>
      </div>
    </div>

    <!-- JONSWAP Spectrum Section -->
    <h1 id="mainTitle"></h1>
    <h2 id="subTitle"></h2>
    <canvas id="spectrumChart" width="900" height="400"></canvas>

    <!-- RAO Section -->
    <h1>Response Amplitude Operators</h1>
    <div class="chart-row">
      <div class="chart-box">
        <h3>Heave Amplitude</h3>
        <canvas id="raoAmpChart" width="400" height="300"></canvas>
      </div>
      <div class="chart-box">
        <h3>Heave Phase</h3>
        <canvas id="raoPhaseChart" width="400" height="300"></canvas>
      </div>
    </div>
    <div class="chart-row">
      <div class="chart-box">
        <h3>Pitch Amplitude</h3>
        <canvas id="raoPitchAmpChart" width="400" height="300"></canvas>
      </div>
      <div class="chart-box">
        <h3>Pitch Phase</h3>
        <canvas id="raoPitchPhaseChart" width="400" height="300"></canvas>
      </div>
    </div>

    <!-- Vertical Motion PSD Section -->
    <h1>Total Vertical Motion Power Spectral Density</h1>
    <canvas id="verticalPSDChart" width="900" height="400"></canvas>

    <!-- MSDV Section -->
    <h1>MSDV at Various Positions Relative to Center of Gravity (COG)</h1>
    <canvas id="msdvBarChart" width="900" height="400"></canvas>
  </div>

  <script>
    // Create sensor instances at the start
    const sensor1 = new Sensor1();
    const sensor2 = new Sensor2();
    
    // Initialize charts
    let waveHeightChart, wavePeriodChart, waveDirectionChart;
    let vesselHeadingChart, vesselSpeedChart;
    let streamingInterval1 = null;
    let streamingInterval2 = null;

    function initializeSensor1Charts() {
      const commonConfig = {
        type: 'line',
        options: {
          responsive: true,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'hour',
                displayFormats: {
                  hour: 'MMM d, HH:mm'
                }
              },
              title: { display: true, text: 'Time' }
            },
            y: {
              beginAtZero: false,
              grid: { display: true }
            }
          },
          plugins: {
            legend: { display: false }
          },
          animation: false
        }
      };

      // Wave Height Chart
      waveHeightChart = new Chart(
        document.getElementById('waveHeightChart').getContext('2d'),
        {
          ...commonConfig,
          data: {
            datasets: [{
              label: 'Wave Height',
              data: [],
              borderColor: 'rgb(45, 185, 164)',
              borderWidth: 2,
              fill: false
            }]
          }
        }
      );

      // Wave Period Chart
      wavePeriodChart = new Chart(
        document.getElementById('wavePeriodChart').getContext('2d'),
        {
          ...commonConfig,
          data: {
            datasets: [{
              label: 'Wave Period',
              data: [],
              borderColor: 'rgb(75, 192, 192)',
              borderWidth: 2,
              fill: false
            }]
          }
        }
      );

      // Wave Direction Chart 
      waveDirectionChart = new Chart(
        document.getElementById('waveDirectionChart').getContext('2d'),
        {
          ...commonConfig,
          data: {
            datasets: [{
              label: 'Wave Direction',
              data: [],
              borderColor: 'rgb(255, 99, 132)',
              borderWidth: 2,
              fill: false
            }]
          }
        }
      );
    }

    function initializeSensor2Charts() {
      const commonConfig = {
        type: 'line',
        options: {
          responsive: true,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'hour',
                displayFormats: {
                  hour: 'MMM d, HH:mm'
                }
              },
              title: { display: true, text: 'Time' }
            },
            y: {
              beginAtZero: false,
              grid: { display: true }
            }
          },
          plugins: {
            legend: { display: false }
          },
          animation: false
        }
      };

      // Vessel Heading Chart
      vesselHeadingChart = new Chart(
        document.getElementById('vesselHeadingChart').getContext('2d'),
        {
          ...commonConfig,
          data: {
            datasets: [{
              label: 'Vessel Heading',
              data: [],
              borderColor: 'rgb(153, 102, 255)',
              borderWidth: 2,
              fill: false
            }]
          },
          options: {
            ...commonConfig.options,
            scales: {
              ...commonConfig.options.scales,
              y: {
                ...commonConfig.options.scales.y,
                title: { display: true, text: 'Degrees' },
                min: 0,
                max: 360
              }
            }
          }
        }
      );

      // Vessel Speed Chart
      vesselSpeedChart = new Chart(
        document.getElementById('vesselSpeedChart').getContext('2d'),
        {
          ...commonConfig,
          data: {
            datasets: [{
              label: 'Vessel Speed',
              data: [],
              borderColor: 'rgb(255, 159, 64)',
              borderWidth: 2,
              fill: false
            }]
          },
          options: {
            ...commonConfig.options,
            scales: {
              ...commonConfig.options.scales,
              y: {
                ...commonConfig.options.scales.y,
                title: { display: true, text: 'Knots' },
                beginAtZero: true
              }
            }
          }
        }
      );
    }

    function updateSensor1Charts(reading) {
      if (!reading) return;

      const time = reading.timestamp;

      // Update wave height
      waveHeightChart.data.datasets[0].data.push({
        x: time,
        y: reading.waveHeight
      });
      if (waveHeightChart.data.datasets[0].data.length > 24) {
        waveHeightChart.data.datasets[0].data.shift();
      }
      
      // Update wave period
      wavePeriodChart.data.datasets[0].data.push({
        x: time,
        y: reading.wavePeriod
      });
      if (wavePeriodChart.data.datasets[0].data.length > 24) {
        wavePeriodChart.data.datasets[0].data.shift();
      }
      
      // Update wave direction
      waveDirectionChart.data.datasets[0].data.push({
        x: time,
        y: reading.waveDirection
      });
      if (waveDirectionChart.data.datasets[0].data.length > 24) {
        waveDirectionChart.data.datasets[0].data.shift();
      }

      // Update all charts
      waveHeightChart.update('none');
      wavePeriodChart.update('none');
      waveDirectionChart.update('none');
    }

    function updateSensor2Charts(reading) {
      if (!reading) return;

      const time = reading.timestamp;

      // Update vessel heading
      vesselHeadingChart.data.datasets[0].data.push({
        x: time,
        y: reading.heading
      });
      if (vesselHeadingChart.data.datasets[0].data.length > 24) {
        vesselHeadingChart.data.datasets[0].data.shift();
      }
      
      // Update vessel speed
      vesselSpeedChart.data.datasets[0].data.push({
        x: time,
        y: reading.speed
      });
      if (vesselSpeedChart.data.datasets[0].data.length > 24) {
        vesselSpeedChart.data.datasets[0].data.shift();
      }

      // Update all charts
      vesselHeadingChart.update('none');
      vesselSpeedChart.update('none');
    }

    // Start/Stop button handlers for Sensor1
    document.getElementById('startBtn1').addEventListener('click', async function() {
      if (!streamingInterval1) {
        this.disabled = true;
        document.getElementById('stopBtn1').disabled = false;
        
        console.log('Loading sensor1 data...');
        const success = await sensor1.loadData();
        
        if (success) {
          streamingInterval1 = sensor1.startStreaming(updateSensor1Charts, 500);
        } else {
          this.disabled = false;
          document.getElementById('stopBtn1').disabled = true;
          alert('Failed to load sensor1 data');
        }
      }
    });

    document.getElementById('stopBtn1').addEventListener('click', function() {
      if (streamingInterval1) {
        clearInterval(streamingInterval1);
        streamingInterval1 = null;
        this.disabled = true;
        document.getElementById('startBtn1').disabled = false;
      }
    });

    // Start/Stop button handlers for Sensor2
    document.getElementById('startBtn2').addEventListener('click', async function() {
      if (!streamingInterval2) {
        this.disabled = true;
        document.getElementById('stopBtn2').disabled = false;
        
        console.log('Loading sensor2 data...');
        const success = await sensor2.loadData();
        
        if (success) {
          streamingInterval2 = sensor2.startStreaming(updateSensor2Charts, 500); // 5-minute interval
        } else {
          this.disabled = false;
          document.getElementById('stopBtn2').disabled = true;
          alert('Failed to load sensor2 data');
        }
      }
    });

    document.getElementById('stopBtn2').addEventListener('click', function() {
      if (streamingInterval2) {
        clearInterval(streamingInterval2);
        streamingInterval2 = null;
        this.disabled = true;
        document.getElementById('startBtn2').disabled = false;
      }
    });

    // Initialize all charts
    initializeSensor1Charts();
    initializeSensor2Charts();
    document.getElementById('stopBtn1').disabled = true;
    document.getElementById('stopBtn2').disabled = true;

    // Initialize titles
    document.getElementById('mainTitle').innerText = 'JONSWAP Wave Spectrum';
    document.getElementById('subTitle').innerText = 
      `Hₛ = ${Hs.toFixed(2)} m, Tₚ = ${Tp.toFixed(2)} s, DateTime = ${timeStamp}`;

    // JONSWAP Spectrum Chart
    new Chart(document.getElementById('spectrumChart').getContext('2d'), {
      type: 'line',
      data: {
        datasets: [{
          data: spectrumData,
          borderColor: 'blue',
          borderWidth: 2,
          pointRadius: 0,
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'linear',
            position: 'bottom',
            title: { 
              display: true, 
              text: 'Angular Frequency ω [rad/s]', 
              font: { size: 14 } 
            }
          },
          y: {
            title: { 
              display: true, 
              text: 'Spectral Density S(ω) [m²/(rad/s)]', 
              font: { size: 14 } 
            }
          }
        },
        plugins: {
          legend: { display: false },
          annotation: {
            annotations: [{
              type: 'line',
              xMin: peakOmega,
              xMax: peakOmega,
              borderColor: 'black',
              borderWidth: 1,
              borderDash: [5, 5],
              label: {
                display: true,
                content: `ωₚ = ${peakOmega.toFixed(2)} rad/s`,
                position: 'end'
              }
            }]
          }
        }
      }
    });

    // Heave RAO Amplitude Chart
    new Chart(document.getElementById('raoAmpChart').getContext('2d'), {
      type: 'line',
      data: {
        datasets: [{
          label: 'Amplitude',
          data: raoAmplitudeData,
          borderColor: 'green',
          borderWidth: 2,
          pointRadius: 0,
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'linear',
            title: { display: true, text: 'Frequency ω [rad/s]' }
          },
          y: {
            title: { display: true, text: 'Amplitude [m/m]' }
          }
        }
      }
    });

    // Heave RAO Phase Chart
    new Chart(document.getElementById('raoPhaseChart').getContext('2d'), {
      type: 'line',
      data: {
        datasets: [{
          label: 'Phase',
          data: raoPhaseData,
          borderColor: 'red',
          borderWidth: 2,
          pointRadius: 0,
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'linear',
            title: { display: true, text: 'Frequency ω [rad/s]' }
          },
          y: {
            title: { display: true, text: 'Phase [°]' }
          }
        }
      }
    });

    // Pitch RAO Amplitude Chart
    new Chart(document.getElementById('raoPitchAmpChart').getContext('2d'), {
      type: 'line',
      data: {
        datasets: [{
          label: 'Pitch Amplitude',
          data: raoPitchAmplitudeData,
          borderColor: 'purple',
          borderWidth: 2,
          pointRadius: 0,
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'linear',
            title: { display: true, text: 'Frequency ω [rad/s]' }
          },
          y: {
            title: { display: true, text: 'Amplitude [rad/(rad)]' }
          }
        }
      }
    });

    // Pitch RAO Phase Chart
    new Chart(document.getElementById('raoPitchPhaseChart').getContext('2d'), {
      type: 'line',
      data: {
        datasets: [{
          label: 'Pitch Phase',
          data: raoPitchPhaseData,
          borderColor: 'orange',
          borderWidth: 2,
          pointRadius: 0,
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'linear',
            title: { display: true, text: 'Frequency ω [rad/s]' }
          },
          y: {
            title: { display: true, text: 'Phase [°]' }
          }
        }
      }
    });

    // Vertical PSD Chart
    new Chart(document.getElementById('verticalPSDChart').getContext('2d'), {
      type: 'line',
      data: {
        datasets: [
          {
            label: 'L = -30 m',
            data: verticalPSDDataMinus30,
            borderColor: 'blue',
            borderWidth: 2,
            pointRadius: 0,
            fill: false
          },
          {
            label: 'L = -15 m',
            data: verticalPSDDataMinus15,
            borderColor: 'orange',
            borderWidth: 2,
            pointRadius: 0,
            fill: false
          },
          {
            label: 'L = 0 m',
            data: verticalPSDData0,
            borderColor: 'gold',
            borderWidth: 2,
            pointRadius: 0,
            fill: false
          },
          {
            label: 'L = 15 m',
            data: verticalPSDData15,
            borderColor: 'purple',
            borderWidth: 2,
            pointRadius: 0,
            fill: false
          },
          {
            label: 'L = 30 m',
            data: verticalPSDData30,
            borderColor: 'green',
            borderWidth: 2,
            pointRadius: 0,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: timeStamp,
            font: { size: 18 }
          },
          legend: {
            display: true,
            position: 'top'
          }
        },
        scales: {
          x: {
            type: 'linear',
            title: { 
              display: true, 
              text: 'ω (rad/s)', 
              font: { size: 14 } 
            }
          },
          y: {
            title: { 
              display: true, 
              text: 'PSD (m²/s⁵)', 
              font: { size: 14 } 
            }
          }
        }
      }
    });

    // MSDV Bar Chart
    new Chart(document.getElementById('msdvBarChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: msdvPositions,
        datasets: [{
          label: 'MSDV_L',
          data: msdvValues,
          barThickness: 20,
          backgroundColor: msdvPositions.map(pos => {
            if (pos === '15 m' || pos === '-15 m') return 'rgba(255, 99, 132, 0.8)';
            if (pos === '30 m' || pos === '-30 m') return 'rgba(54, 162, 235, 0.8)';
            return 'rgba(255, 206, 86, 0.8)';
          })
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: timeStamp,
            font: { size: 18 }
          },
          legend: { display: false }
        },
        scales: {
          x: {
            title: { 
              display: true, 
              text: 'Position relative to COG', 
              font: { size: 14 } 
            }
          },
          y: {
            title: { 
              display: true, 
              text: 'MSDV_L', 
              font: { size: 14 } 
            },
            beginAtZero: true
          }
        }
      }
    });
  </script>
</body>
</html>
